<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenXLLM Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 25px 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 { 
            color: #667eea; 
            margin-bottom: 8px;
            font-size: 28px;
        }
        
        .header-left p { 
            color: #666; 
            font-size: 14px;
        }
        
        .wallet-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .wallet-info {
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 12px;
            display: none;
        }
        
        .wallet-info.connected {
            display: block;
        }
        
        .wallet-address {
            font-family: monospace;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        
        .wallet-balance {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .quota-banner {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .quota-banner.show {
            display: block;
        }
        
        .quota-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .quota-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .quota-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .quota-badge.free {
            background: #d4edda;
            color: #155724;
        }
        
        .quota-badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .quota-badge.paid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .quota-progress {
            background: #e0e0e0;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .quota-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s, background 0.3s;
        }
        
        .quota-progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }
        
        .quota-progress-bar.danger {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .quota-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
        }
        
        .quota-cost-warning {
            background: #fff3cd;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .quota-cost-warning.show {
            display: block;
        }
        
        .quota-cost-warning strong {
            color: #856404;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 { 
            color: #666; 
            font-size: 13px; 
            margin-bottom: 10px; 
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-card .value { 
            color: #667eea; 
            font-size: 28px; 
            font-weight: 700;
        }
        
        .stat-card .subtitle { 
            color: #999; 
            margin-top: 5px; 
            font-size: 13px;
        }
        
        .usage-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .usage-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .usage-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .admin-section {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .admin-section.show {
            display: grid;
        }
        
        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .admin-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.show {
            display: flex;
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üöÄ TokenXLLM Dashboard</h1>
                <p>Gesti√≥n de tokens y uso del sistema en Starknet</p>
            </div>
            <div class="wallet-section">
                <div class="wallet-info" id="walletInfo">
                    <div class="wallet-address" id="walletAddress">0x...</div>
                    <div class="wallet-balance" id="walletBalance">Balance: -- AIC</div>
                </div>
                <button class="btn-primary" id="connectBtn">Conectar Wallet</button>
                <button class="btn-secondary" id="disconnectBtn" style="display: none;">Desconectar</button>
            </div>
        </div>

        <div class="quota-banner" id="quotaBanner">
            <div class="quota-header">
                <span class="quota-title">üìä Tu Cuota de Uso</span>
                <span class="quota-badge free" id="quotaBadge">Gratis</span>
            </div>
            <div class="quota-progress">
                <div class="quota-progress-bar" id="quotaProgressBar" style="width: 0%"></div>
            </div>
            <div class="quota-info">
                <span id="quotaUsed">Usado: 0 / 100,000 unidades</span>
                <span id="quotaRemaining">Restante: 100,000 unidades</span>
            </div>
            <div class="quota-cost-warning" id="costWarning">
                <strong>‚ö†Ô∏è Pr√≥ximo uso ser√° cobrado:</strong> Se te cobrar√° <span id="costAmount">0.01</span> AIC por unidad adicional.
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Token</h3>
                <div class="value" id="tokenSymbol">AIC</div>
                <div class="subtitle" id="tokenName">AI Coin</div>
            </div>
            <div class="stat-card">
                <h3>Total Supply</h3>
                <div class="value" id="totalSupply">0.00</div>
                <div class="subtitle">AIC</div>
            </div>
            <div class="stat-card">
                <h3>Current Epoch</h3>
                <div class="value" id="currentEpoch">0</div>
                <div class="subtitle">√âpoca actual</div>
            </div>
            <div class="stat-card">
                <h3>Free Quota</h3>
                <div class="value" id="freeQuota">0</div>
                <div class="subtitle">unidades/√©poca</div>
            </div>
            <div class="stat-card">
                <h3>Price per Unit</h3>
                <div class="value" id="pricePerUnit">0.0000</div>
                <div class="subtitle">AIC/unidad</div>
            </div>
        </div>

        <div class="usage-form">
  <div class="form-group">
    <label>Unidades a consumir</label>
    <input type="number" id="unitsInput" placeholder="Ej: 50" min="1">
  </div>
  <button class="btn-primary" id="authorizeBtn">Autorizar Uso</button>
  <!-- NUEVO -->
  <button class="btn-secondary" id="spendBtn" title="Consumir unidades">Gastar</button>
</div>


        <div class="admin-section" id="adminSection">
            <div class="admin-card">
                <h2>üí∞ Mint Tokens</h2>
                <div class="form-group">
                    <label>Direcci√≥n destino</label>
                    <input type="text" id="mintAddress" placeholder="0x...">
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="mintAmount" placeholder="100.00" step="0.01">
                </div>
                <button class="btn-primary" id="mintBtn">Mint Tokens</button>
            </div>

            <div class="admin-card">
                <h2>üíµ Configurar Precio</h2>
                <div class="form-group">
                    <label>Nuevo precio por unidad</label>
                    <input type="number" id="priceInput" placeholder="0.0100" step="0.0001">
                </div>
                <button class="btn-primary" id="setPriceBtn">Actualizar Precio</button>
            </div>

            <div class="admin-card">
                <h2>üéÅ Configurar Cuota Gratis</h2>
                <div class="form-group">
                    <label>Nueva cuota por √©poca</label>
                    <input type="number" id="quotaInput" placeholder="100000">
                </div>
                <button class="btn-primary" id="setQuotaBtn">Actualizar Cuota</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script src="https://unpkg.com/get-starknet@3.3.0/dist/index.iife.js"></script>
    <script>
        const BACKEND_URL = '';
        
        let snAccount = null;
        let connectedAddress = null;
        let contractAddresses = { token: null, usageManager: null };

        function extractAccountInfo(...sources) {
            for (const src of sources) {
                if (!src) continue;

                const accountsArray = Array.isArray(src)
                    ? src
                    : Array.isArray(src?.accounts)
                    ? src.accounts
                    : [];

                let account =
                    src?.account ||
                    src?.selectedAccount ||
                    (accountsArray.length ? accountsArray[0] : null);

                if (!account && src?.wallet) {
                    account = src.wallet.account || null;
                }

                let address =
                    (typeof account === 'string' ? account : account?.address) ||
                    src?.selectedAddress ||
                    src?.selectedAccountAddress ||
                    (accountsArray.length
                        ? typeof accountsArray[0] === 'string'
                            ? accountsArray[0]
                            : accountsArray[0]?.address
                        : null);

                if (!address && Array.isArray(src) && src.length) {
                    address =
                        typeof src[0] === 'string'
                            ? src[0]
                            : src[0]?.address || null;
                }

                if (address) {
                    if (typeof account === 'string') {
                        account = null;
                    }

                    if (!account && typeof src?.account === 'object') {
                        account = src.account;
                    }

                    if (!account && Array.isArray(src?.accounts) && src.accounts[0]?.address) {
                        account = src.accounts[0];
                    }

                    return { account: account || null, address };
                }
            }

            return { account: null, address: null };
        }

        // ======================
// Helpers para ejecutar directamente en la wallet
// ======================

async function requireWallet() {
  if (!snAccount || !connectedAddress) throw new Error('Conect√° tu wallet primero');
  return snAccount;
}

async function starkExecute(calls) {
  const account = await requireWallet();
  if (account.execute_v3) return account.execute_v3({ calls, autoEstimate: true });
  return account.execute(calls, { version: 1, autoEstimate: true });
}

async function callAuthorize(units) {
  const calls = [{
    contractAddress: contractAddresses.usageManager,
    entrypoint: 'authorize_usage',
    calldata: [String(units)]
  }];

  const tx = await starkExecute(calls);
  const txHash = tx.hash || tx.transaction_hash;
  showToast(`‚úÖ Uso autorizado! TX: ${String(txHash).slice(0,10)}...`, 'success');
  await loadDashboardData();
}


        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const walletBalance = document.getElementById('walletBalance');
        const quotaBanner = document.getElementById('quotaBanner');
        const adminSection = document.getElementById('adminSection');

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toast.className = `toast ${type} show`;
            toastMessage.textContent = message;
            setTimeout(() => toast.classList.remove('show'), 5000);
        }


       document.getElementById('spendBtn')?.addEventListener('click', async () => {
  try {
    const units = parseInt(document.getElementById('unitsInput').value);
    if (!units || units <= 0) return showToast('Ingres√° una cantidad v√°lida', 'warning');
    const btn = document.getElementById('spendBtn');
    btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Gastando...';
    await callAuthorize(units);
  } catch (e) {
    console.error(e);
    showToast('Error: ' + (e?.message || e), 'error');
  } finally {
    const btn = document.getElementById('spendBtn');
    btn.disabled = false; btn.innerHTML = 'Gastar';
  }
});


        connectBtn.addEventListener('click', async () => {
            try {
                console.log('Intentando conectar wallet...');
                console.log('window.starknet_argentX:', window.starknet_argentX);
                console.log('window.starknet:', window.starknet);
                console.log('window.braavos:', window.braavos);

                // Esperar a que la wallet est√© disponible
                let attempts = 0;
                while (
                    !window.starknet &&
                    !window.starknet_argentX &&
                    !window.starknet_braavos &&
                    !window.braavos &&
                    attempts < 10
                ) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (
                    !window.starknet &&
                    !window.starknet_argentX &&
                    !window.starknet_braavos &&
                    !window.braavos
                ) {
                    showToast('Por favor instala una wallet de Starknet (Argent X o Braavos)', 'error');
                    window.open('https://www.braavos.app/download', '_blank');
                    window.open('https://www.argent.xyz/argent-x/', '_blank');
                    return;
                }

                // Intentar con diferentes proveedores
                let starknet = null;
                let enableResult = null;

                // 1. Intentar con el proveedor gen√©rico (Ready Wallet/ArgentX)
                if (window.starknet) {
                    console.log('Usando window.starknet');
                    starknet = await window.starknet.enable();
                    enableResult = starknet;
                }
                // 2. Intentar con argentX expl√≠citamente
                else if (window.starknet_argentX) {
                    console.log('Usando window.starknet_argentX');
                    starknet = await window.starknet_argentX.enable();
                    enableResult = starknet;
                }
                // 3. Intentar con Braavos usando el objeto legacy
                else if (window.starknet_braavos) {
                    console.log('Usando window.starknet_braavos');
                    starknet = await window.starknet_braavos.enable();
                    enableResult = starknet;
                }
                // 4. Intentar con la API moderna de Braavos
                else if (window.braavos) {
                    console.log('Usando window.braavos');
                    const braavos = window.braavos;
                    try {
                        if (typeof braavos.request === 'function') {
                            try {
                                enableResult = await braavos.request({ type: 'starknet_requestAccounts' });
                            } catch (requestError) {
                                console.warn('starknet_requestAccounts fall√≥, intentando wallet_requestAccounts', requestError);
                                enableResult = await braavos.request({ method: 'wallet_requestAccounts' });
                            }
                        } else if (typeof braavos.enable === 'function') {
                            enableResult = await braavos.enable();
                        }
                    } catch (walletError) {
                        console.error('Error solicitando cuentas a Braavos:', walletError);
                        throw walletError;
                    }

                    starknet = braavos.starknet || braavos;
                }

                if (!starknet) {
                    showToast('No se pudo conectar con la wallet', 'error');
                    return;
                }

                const { account, address } = extractAccountInfo(
                    enableResult,
                    starknet,
                    window.starknet,
                    window.starknet_argentX,
                    window.starknet_braavos,
                    window.braavos
                );

                snAccount =
                    account ||
                    starknet?.account ||
                    window.braavos?.account ||
                    window.starknet?.account ||
                    window.starknet_argentX?.account ||
                    window.starknet_braavos?.account ||
                    null;
                connectedAddress = address || null;

                console.log('Wallet conectada:', starknet);
                console.log('isConnected:', starknet.isConnected);
                console.log('selectedAddress:', connectedAddress);
                console.log('account:', snAccount);

                if (!connectedAddress) {
                    showToast('No se pudo obtener la direcci√≥n de la wallet', 'error');
                    return;
                }

                if (!snAccount) {
                    showToast('La wallet no expuso el objeto account necesario', 'error');
                    return;
                }

                walletAddress.textContent = `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`;
                walletInfo.classList.add('connected');
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                quotaBanner.classList.add('show');

                await loadDashboardData();
                showToast('Wallet conectada exitosamente', 'success');

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showToast('Error al conectar wallet: ' + (error?.message || error), 'error');
            }
        });

        disconnectBtn.addEventListener('click', async () => {
            try {
                if (window.starknet_argentX?.isConnected) {
                    await window.starknet_argentX.disable?.();
                } else if (window.starknet_braavos?.isConnected) {
                    await window.starknet_braavos.disable?.();
                } else if (window.braavos?.isConnected) {
                    await window.braavos.disable?.();
                } else if (window.starknet?.isConnected) {
                    await window.starknet.disable?.();
                }
            } catch (error) {
                console.log('Wallet disconnect not supported:', error);
            }
            
            snAccount = null;
            connectedAddress = null;
            walletInfo.classList.remove('connected');
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
            quotaBanner.classList.remove('show');
            adminSection.classList.remove('show');
            showToast('Wallet desconectada', 'success');
        });

        async function loadDashboardData() {
            try {
                const configRes = await fetch(`${BACKEND_URL}/config`);
                const config = await configRes.json();
                
                contractAddresses.token = config.aic_addr;
                contractAddresses.usageManager = config.um_addr;
                
                if (connectedAddress) {
                    const balanceRes = await fetch(`${BACKEND_URL}/balance?user=${connectedAddress}`);
                    const balanceData = await balanceRes.json();
                    walletBalance.textContent = `Balance: ${parseFloat(balanceData.balance_AIC).toFixed(2)} AIC`;
                    
                    const quotaRes = await fetch(`${BACKEND_URL}/free_quota?user=${connectedAddress}`);
                    const quotaData = await quotaRes.json();
                    updateQuotaDisplay(quotaData);
                    
                    if (config.account_address && connectedAddress.toLowerCase() === config.account_address.toLowerCase()) {
                        adminSection.classList.add('show');
                    }
                }
                
                const epochRes = await fetch(`${BACKEND_URL}/epoch`);
                const epochData = await epochRes.json();
                document.getElementById('currentEpoch').textContent = epochData.epoch_id;
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error al cargar datos', 'error');
            }
        }

        function updateQuotaDisplay(quotaData) {
            const freeQuota = quotaData.free_quota;
            const usedUnits = quotaData.used_units || 0;
            const remaining = quotaData.free_remaining || freeQuota;
            const pricePerUnit = parseFloat(quotaData.price_per_unit_wei) / 1e18;
            
            document.getElementById('freeQuota').textContent = freeQuota.toLocaleString();
            document.getElementById('pricePerUnit').textContent = pricePerUnit.toFixed(4);
            document.getElementById('quotaUsed').textContent = `Usado: ${usedUnits.toLocaleString()} / ${freeQuota.toLocaleString()} unidades`;
            document.getElementById('quotaRemaining').textContent = `Restante: ${remaining.toLocaleString()} unidades`;
            
            const percentage = (usedUnits / freeQuota) * 100;
            const progressBar = document.getElementById('quotaProgressBar');
            const quotaBadge = document.getElementById('quotaBadge');
            const costWarning = document.getElementById('costWarning');
            
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            
            if (percentage >= 100) {
                progressBar.className = 'quota-progress-bar danger';
                quotaBadge.className = 'quota-badge paid';
                quotaBadge.textContent = 'Pagando';
                costWarning.classList.add('show');
            } else if (percentage >= 80) {
                progressBar.className = 'quota-progress-bar warning';
                quotaBadge.className = 'quota-badge warning';
                quotaBadge.textContent = 'Casi agotado';
                costWarning.classList.add('show');
            } else {
                progressBar.className = 'quota-progress-bar';
                quotaBadge.className = 'quota-badge free';
                quotaBadge.textContent = 'Gratis';
                costWarning.classList.remove('show');
            }
            
            document.getElementById('costAmount').textContent = pricePerUnit.toFixed(4);
        }

        document.getElementById('authorizeBtn').addEventListener('click', async () => {
  try {
    const units = parseInt(document.getElementById('unitsInput').value);
    if (!units || units <= 0) return showToast('Ingres√° una cantidad v√°lida', 'warning');
    const btn = document.getElementById('authorizeBtn');
    btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Autorizando...';
    await callAuthorize(units);
  } catch (e) {
    console.error(e);
    showToast('Error: ' + (e?.message || e), 'error');
  } finally {
    const btn = document.getElementById('authorizeBtn');
    btn.disabled = false; btn.innerHTML = 'Autorizar Uso';
  }
});


        document.getElementById('mintBtn').addEventListener('click', async () => {
            const address = document.getElementById('mintAddress').value;
            const amount = parseFloat(document.getElementById('mintAmount').value);
            
            if (!address || !amount) {
                showToast('Por favor completa todos los campos', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/mint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: address, amount })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`‚úÖ Tokens minteados! TX: ${data.tx_hash.slice(0, 10)}...`, 'success');
                    await loadDashboardData();
                } else {
                    throw new Error(data.detail || 'Error al mintear');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('setPriceBtn').addEventListener('click', async () => {
            const price = parseFloat(document.getElementById('priceInput').value);
            
            if (!price || price <= 0) {
                showToast('Por favor ingresa un precio v√°lido', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/set_price`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price_AIC: price })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`‚úÖ Precio actualizado! TX: ${data.tx_hash.slice(0, 10)}...`, 'success');
                    await loadDashboardData();
                } else {
                    throw new Error(data.detail || 'Error al actualizar precio');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('setQuotaBtn').addEventListener('click', async () => {
            const quota = parseInt(document.getElementById('quotaInput').value);
            
            if (!quota || quota < 0) {
                showToast('Por favor ingresa una cuota v√°lida', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/set_free_quota`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_quota: quota })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`‚úÖ Cuota actualizada! TX: ${data.tx_hash.slice(0, 10)}...`, 'success');
                    await loadDashboardData();
                } else {
                    throw new Error(data.detail || 'Error al actualizar cuota');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        (async () => {
            try {
                const configRes = await fetch(`${BACKEND_URL}/config`);
                const config = await configRes.json();
                
                const epochRes = await fetch(`${BACKEND_URL}/epoch`);
                const epochData = await epochRes.json();
                document.getElementById('currentEpoch').textContent = epochData.epoch_id;
                
                const quotaRes = await fetch(`${BACKEND_URL}/free_quota`);
                const quotaData = await quotaRes.json();
                document.getElementById('freeQuota').textContent = quotaData.free_quota.toLocaleString();
                document.getElementById('pricePerUnit').textContent = (parseFloat(quotaData.price_per_unit_wei) / 1e18).toFixed(4);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        })();
    </script>
</body>
</html>